version: "3"

services:
  rabbitmq:
    container_name: rabbitmq
    image: rabbitmq:3.12.4-alpine
    ports:
      - "5672:5672"

  database:
    container_name: database
    image: postgres:15.4-alpine3.18
    restart: always
    env_file:
      - ./.env
    ports:
      - "5432:5432"
    volumes:
      - ./apps/content/dumps/dump.sql:/docker-entrypoint-initdb.d/dump.sql
      - db:/var/lib/postgresql/data

  # api-gateway:
  #   container_name: api-gateway
  #   build:
  #     context: .
  #     dockerfile: ./apps/backend/Dockerfile
  #     target: production
  #   restart: always
  #   depends_on:
  #     - rabbitmq
  #     - database
  #     - content
  #   ports:
  #     - "5000:5000"
  #   volumes:
  #     - .:/usr/src/app
  #     - /usr/src/app/node_modules

  # content:
  #   container_name: content-microservice
  #   build:
  #     context: .
  #     dockerfile: ./apps/content/Dockerfile
  #     target: production
  #   restart: always
  #   depends_on:
  #     - rabbitmq
  #     - database
  #   volumes:
  #     - .:/usr/src/app
  #     - /usr/src/app/node_modules

  api-gateway:
    container_name: api-gateway
    build:
      context: .
      dockerfile: ./apps/backend/Dockerfile
      target: production
    # command: npm run start:dev backend
    env_file:
      - ./.env
    depends_on:
      - rabbitmq
      - database
      - content
    ports:
      - '5000:5000'

  content:
    container_name: content-microservice
    build:
      context: .
      dockerfile: ./apps/content/Dockerfile
      target: production
    # command: npm run start:dev content
    env_file:
      - ./.env
    depends_on:
      - rabbitmq
      - database

volumes:
  db: